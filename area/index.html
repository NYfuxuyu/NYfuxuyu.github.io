<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>场景设计 | 知识星球</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/avatar.jpg">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.a26fb221.css" as="style"><link rel="preload" href="/assets/js/app.3bc42cf8.js" as="script"><link rel="preload" href="/assets/js/3.0146fe10.js" as="script"><link rel="preload" href="/assets/js/1.760be874.js" as="script"><link rel="preload" href="/assets/js/11.d5259c34.js" as="script"><link rel="prefetch" href="/assets/js/10.2fa36d92.js"><link rel="prefetch" href="/assets/js/12.3b11beda.js"><link rel="prefetch" href="/assets/js/13.8e606e78.js"><link rel="prefetch" href="/assets/js/14.7e273577.js"><link rel="prefetch" href="/assets/js/15.9080a48f.js"><link rel="prefetch" href="/assets/js/16.62996748.js"><link rel="prefetch" href="/assets/js/17.afa987aa.js"><link rel="prefetch" href="/assets/js/18.04a1e384.js"><link rel="prefetch" href="/assets/js/19.51469f95.js"><link rel="prefetch" href="/assets/js/20.180dc3cd.js"><link rel="prefetch" href="/assets/js/21.32d43e7f.js"><link rel="prefetch" href="/assets/js/22.f1326aa2.js"><link rel="prefetch" href="/assets/js/23.35607ff8.js"><link rel="prefetch" href="/assets/js/24.60cebcf3.js"><link rel="prefetch" href="/assets/js/25.4b8dd78e.js"><link rel="prefetch" href="/assets/js/26.13c2f0ff.js"><link rel="prefetch" href="/assets/js/4.a5370f7a.js"><link rel="prefetch" href="/assets/js/5.716a9c5a.js"><link rel="prefetch" href="/assets/js/6.048f2fb7.js"><link rel="prefetch" href="/assets/js/7.c3f4f112.js"><link rel="prefetch" href="/assets/js/8.64d54cc1.js"><link rel="prefetch" href="/assets/js/9.4411a8b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a26fb221.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>知识星球</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>知识星球</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="知识星球" class="logo"> <span class="site-name">知识星球</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      计算机基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/" class="nav-link"><i class="iconfont reco-network"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/operationsystem/" class="nav-link"><i class="iconfont reco-system"></i>
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-sql"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/sql/Redis.html" class="nav-link"><i class="iconfont undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-java"></i>
      Java基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javase/" class="nav-link"><i class="iconfont undefined"></i>
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/collection/" class="nav-link"><i class="iconfont undefined"></i>
  Java集合
</a></li><li class="dropdown-item"><!----> <a href="/juc/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mybatis/" class="nav-link"><i class="iconfont undefined"></i>
  Mybaits
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      扩展
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/data/" class="nav-link"><i class="iconfont undefined"></i>
  海量数据
</a></li><li class="dropdown-item"><!----> <a href="/area/" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  系统设计题
</a></li><li class="dropdown-item"><!----> <a href="/suanfa/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/iq/" class="nav-link"><i class="iconfont undefined"></i>
  智力题
</a></li><li class="dropdown-item"><!----> <a href="/shejimoshi/" class="nav-link"><i class="iconfont undefined"></i>
  设计模式
</a></li></ul></div></div><div class="nav-item"><a href="http://blog.fuxuyu.top/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/fuxuyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/NYfuxuyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><!----> <h3 class="name" data-v-ca798c94>
    知识星球
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>16</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>14</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      计算机基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/" class="nav-link"><i class="iconfont reco-network"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/operationsystem/" class="nav-link"><i class="iconfont reco-system"></i>
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-sql"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/sql/Redis.html" class="nav-link"><i class="iconfont undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-java"></i>
      Java基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javase/" class="nav-link"><i class="iconfont undefined"></i>
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/collection/" class="nav-link"><i class="iconfont undefined"></i>
  Java集合
</a></li><li class="dropdown-item"><!----> <a href="/juc/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mybatis/" class="nav-link"><i class="iconfont undefined"></i>
  Mybaits
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      扩展
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/data/" class="nav-link"><i class="iconfont undefined"></i>
  海量数据
</a></li><li class="dropdown-item"><!----> <a href="/area/" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  系统设计题
</a></li><li class="dropdown-item"><!----> <a href="/suanfa/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/iq/" class="nav-link"><i class="iconfont undefined"></i>
  智力题
</a></li><li class="dropdown-item"><!----> <a href="/shejimoshi/" class="nav-link"><i class="iconfont undefined"></i>
  设计模式
</a></li></ul></div></div><div class="nav-item"><a href="http://blog.fuxuyu.top/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/fuxuyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/NYfuxuyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>场景设计</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>知识星球</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-2d5f533b><main class="page"><div class="page-title" style="display:none;"><h1 class="title">场景设计</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>仪轩</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2022-09-16</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>场景设计</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>场景设计</p></blockquote> <h2 id="系统设计思路"><a href="#系统设计思路" class="header-anchor">#</a> 系统设计思路</h2> <p>这部分内容主要参考了Github的一个国外的开源项目，写的很好，感兴趣的小伙伴可以去看看：</p> <p>https:// github.com/donnemartin/system-design-primer</p> <p>常见的系统设计题有设计一个秒杀系统、红包雨、URL短网址等，完成一个系统设计题大概需要分为四步。 需要注意的是，在面试过程中是比较紧张的，但遇到这种系统设计题，一定先不要急着回答，一定要先需要设计系统的一些使用场景。</p> <ol><li>第一步：像面试官不断提问，搞清楚系统的使用场景 系统的功能是什么系统的目标群体是什么系统的用户量有多大 希望每秒钟处理多少请求？希望处理多少数据？希望的读写比率？</li> <li>第二步：创造一个高层级的设计画出主要的组件和连接</li></ol> <p>例如设计一个网络爬虫，这个是个完整的架构图，在这一步只需要画出一个抽象的架构图即 可，不需要这么具体。</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072100719.png" alt="image-20220507210044470"></p> <ol start="3"><li>设计核心组件 对每一个核心组件进行具体地分析。例如，面试官让你设计一个url短网址，你需要考虑这些问题</li></ol> <ul><li>生成并储存一个完整 url 的hash
<ul><li>MD5和 Base62</li> <li>Hash 碰撞</li> <li>SQL 还是 NoSQL</li> <li>数据库模型</li></ul></li> <li>将一个 hashed url 翻译成完整的 url
<ul><li>数据库查找</li></ul></li> <li>API 和面向对象设计</li></ul> <ol start="4"><li>对系统进行优化找到系统的瓶颈所在，对其进行优化，例如可以考虑水平扩展、数据库分片等等。</li></ol> <h2 id="系统性能指标"><a href="#系统性能指标" class="header-anchor">#</a> 系统性能指标</h2> <ol><li><p>响应时间</p> <p>响应时间指从发出请求开始到收到最后响应数据所需的时间，响应时间是系统最重要的性能指标其直观地反映了系统的“快慢”。</p></li> <li><p>并发数</p> <p>并发数指系统能够同时处理请求的数目，这个数字反映了系统的负载特性。</p></li> <li><p>吞吐量</p> <p>吞吐量指单位时间内系统处理的请求数量，体现系统的整体处理能力。</p> <p>QPS（Query Per Second）：服务器每秒可以执行的查询次数</p> <p>TPS（Transaction Per Second）：服务器每秒处理的事务数</p> <p>并发数=QPS*平均响应时间</p></li> <li><p>经常听到的一些系统活跃度的名词</p> <ul><li><p>PV（Page View）</p> <p>页面点击量或者浏览量，用户每次对网站中的每个页面访问均被记录一个PV，多次访问则会累计</p></li> <li><p>UV（Unique visitor）</p> <p>独立访客，统计一天内访问网站的用户数，一个用户多次访问网站算一个用户</p></li> <li><p>IP（Internet Protocol）</p> <p>指一天内访问某站点的IP总数，以用户的IP地址作为统计的指标，相同IP多次访问某站点算一 次</p> <p>IP和UV的区别： 在同一个IP地址下，两个不同的账号访问同一个站点，UV算两次，IP算一次</p></li> <li><p>DAU（Daily Active User）：日活跃用户数量。</p></li> <li><p>MAU(monthly active users)：月活跃用户人数。</p></li></ul></li> <li><p>常用软件的QPS</p> <ul><li>Nginx：一般Nginx的QPS是比较大的，单机的可达到30万</li> <li>MySQL：对于读操作可达几百k，对于写操作更低，大概只有100k</li> <li>Redis：大概在几万左右，像set命令甚至可达10万</li> <li>Tomcat：单机 Tomcat 的QPS 在 2万左右。</li> <li>Memcached：大概在几十万左右</li></ul></li></ol> <h2 id="经典系统设计题目"><a href="#经典系统设计题目" class="header-anchor">#</a> 经典系统设计题目</h2> <h3 id="分布式id生成器"><a href="#分布式id生成器" class="header-anchor">#</a> 分布式ID生成器</h3> <p>如何设计一个分布式ID生成器(Distributed ID Generator)，并保证ID按时间粗略有序？</p> <p>应用场景(Scenario)</p> <p>现实中很多业务都有生成唯一ID的需求，例如：</p> <ul><li>用户ID</li> <li>微博ID</li> <li>聊天消息ID</li> <li>帖子ID</li> <li>订单ID</li></ul> <p>这个ID往往会作为数据库主键，所以需要保证全局唯一。数据库会在这个字段上建立聚集索引 (Clustered Index，参考 MySQL InnoDB)，即该字段会影响各条数据再物理存储上的顺序。</p> <p>ID还要尽可能短，节省内存，让数据库索引效率更高。基本上64位整数能够满足绝大多数的场景，但是 如果能做到比64位更短那就更好了。需要根据具体业务进行分析，预估出ID的最大值，这个最大值通常 比64位整数的上限小很多，于是我们可以用更少的bit表示这个ID。</p> <p>查询的时候，往往有分页或者排序的需求，所以需要给每条数据添加一个时间字段，并在其上建立普通 索引(Secondary Index)。但是普通索引的访问效率比聚集索引慢，如果能够让ID按照时间粗略有序，则 可以省去这个时间字段。为什么不是按照时间精确有序呢？因为按照时间精确有序是做不到的，除非用 一个单机算法，在分布式场景下做到精确有序性能一般很差。</p> <p><strong>这就引出了ID生成的三大核心需求：</strong></p> <ul><li>全局唯一(unique)</li> <li>按照时间粗略有序(sortable by time)</li> <li>尽可能短</li></ul> <p>下面介绍一些常用的生成ID的方法。</p> <p>UUID</p> <p>用过MongoDB的人会知道，MongoDB会自动给每一条数据赋予一个唯一的ObjectId,保证不会重复，这 是怎么做到的呢？实际上它用的是一种UUID算法，生成的ObjectId占12个字节，由以下几个部分组成，</p> <ul><li>4个字节表示的Unix timestamp</li> <li>3个字节表示的机器的ID</li> <li>2个字节表示的进程ID</li> <li>3个字节表示的计数器</li></ul> <p>UUID是一类算法的统称，具体有不同的实现。UUID的有点是每台机器可以独立产生ID，理论上保证不会重复，所以天然是分布式的，缺点是生成的ID太长，不仅占用内存，而且索引查询效率低。</p> <p>多台MySQL服务器</p> <p>既然MySQL可以产生自增ID，那么用多台MySQL服务器，能否组成一个高性能的分布式发号器呢？ 显然可以。</p> <p>假设用8台MySQL服务器协同工作，第一台MySQL初始值是1，每次自增8，第二台MySQL初始值是2， 每次自增8，依次类推。前面用一个 round-robin load balancer 挡着，每来一个请求，由 round-robin  balancer 随机地将请求发给8台MySQL中的任意一个，然后返回一个ID。</p> <p>Flickr就是这么做的，仅仅使用了两台MySQL服务器。可见这个方法虽然简单无脑，但是性能足够好。 不过要注意，在MySQL中，不需要把所有ID都存下来，每台机器只需要存一个MAX_ID就可以了。这需要用到MySQL的一个REPLACE INTO特性。</p> <p>这个方法跟单台数据库比，缺点是ID是不是严格递增的，只是粗略递增的。不过这个问题不大，我们的目标是粗略有序，不需要严格递增。</p> <p><strong>Twitter Snowflake</strong></p> <p>比如 Twitter 有个成熟的开源项目，就是专门生成ID的，Twitter Snowflake 。Snowflake的核心算法如下：</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072110162.png" alt="image-20220507211034902"></p> <p>最高位不用，永远为0，其余三组bit占位均可浮动，看具体的业务需求而定。默认情况下41bit的时间戳 可以支持该算法使用到2082年，10bit的工作机器id可以支持1023台机器，序列号支持1毫秒产生4095 个自增序列id。</p> <p>Instagram用了类似的方案，41位表示时间戳，13位表示shard Id(一个shard Id对应一台PostgreSQL机 器),最低10位表示自增ID，怎么样，跟Snowflake的设计非常类似吧。这个方案用一个PostgreSQL集群 代替了Twitter Snowflake 集群，优点是利用了现成的PostgreSQL，容易懂，维护方便。</p> <p>有的面试官会问，如何让ID可以粗略的按照时间排序？上面的这种格式的ID，含有时间戳，且在高位， 恰好满足要求。如果面试官又问，如何保证ID严格有序呢？在分布式这个场景下，是做不到的，要想高性能，只能做到粗略有序，无法保证严格有序。</p> <h3 id="短网址系统"><a href="#短网址系统" class="header-anchor">#</a> 短网址系统</h3> <p>如何设计一个短网址服务(TinyURL)？</p> <p><strong>使用场景(Scenario)</strong></p> <p>微博和Twitter都有140字数的限制，如果分享一个长网址，很容易就超出限制，发布出去。短网址服务 可以把一个长网址变成短网址，方便在社交网络上传播。</p> <p>短网址的长度</p> <p>当前互联网上的网页总数大概是 45亿(参考 http://www.worldwidewebsize.com)，45亿超过了 2^{32}=4294967296232=4294967296，但远远小于64位整数的上限值，那么用一个64位整数足够了。</p> <p>微博的短网址服务用的是长度为7的字符串，这个字符串可以看做是62进制的数，那么最大能表示 {62}^7=3521614606208627=3521614606208个网址，远远大于45亿。所以长度为7就足够了。</p> <p>一个64位整数如何转化为字符串呢？，假设我们只是用大小写字母加数字，那么可以看做是62进制数， log_{62} {(2^{64}-1)}=10.7log62(264−1)=10.7，即字符串最长11就足够了。</p> <p>实际生产中，还可以再短一点，比如新浪微博采用的长度就是7，因为 62^7=3521614606208627=3521614606208，这个量级远远超过互联网上的URL总数了，绝对够用 了。</p> <p>现代的web服务器（例如Apache, Nginx）大部分都区分URL里的大小写了，所以用大小写字母来区分不 同的URL是没问题的。</p> <p>因此，<strong>正确答案：长度不超过7的字符串，由大小写字母加数字共62个字母组成</strong></p> <p>一对一还是一对多映射？</p> <p>一个长网址，对应一个短网址，还是可以对应多个短网址？ 这也是个重大选择问题</p> <p>一般而言，一个长网址，在不同的地点，不同的用户等情况下，生成的短网址应该不一样，这样，在后端数据库中，可以更好的进行数据分析。如果一个长网址与一个短网址一一对应，那么在数据库中，仅有一行数据，无法区分不同的来源，就无法做数据分析了。</p> <p>以这个7位长度的短网址作为唯一ID，这个ID下可以挂各种信息，比如生成该网址的用户名，所在网站， HTTP头部的 User Agent等信息，收集了这些信息，才有可能在后面做大数据分析，挖掘数据的价值。 短网址服务商的一大盈利来源就是这些数据。</p> <p><strong>正确答案：一对多</strong></p> <p>如何计算短网址</p> <p>现在我们设定了短网址是一个长度为7的字符串，如何计算得到这个短网址呢？ 最容易想到的办法是哈希，先hash得到一个64位整数，将它转化为62进制整，截取低7位即可。但是哈 希算法会有冲突，如何处理冲突呢，又是一个麻烦。这个方法只是转移了矛盾，没有解决矛盾，抛弃。</p> <p><strong>正确答案：分布式ID生成器</strong></p> <p>如何存储</p> <p>如果存储短网址和长网址的对应关系？以短网址为 primary key, 长网址为value, 可以用传统的关系数据 库存起来，例如MySQL, PostgreSQL，也可以用任意一个分布式KV数据库，例如Redis, LevelDB。</p> <p>如果你手痒想要手工设计这个存储，那就是另一个话题了，你需要完整地造一个KV存储引擎轮子。当前 流行的KV存储引擎有LevelDB何RockDB，去读它们的源码吧</p> <p>301还是302重定向</p> <p>这也是一个有意思的问题。这个问题主要是考察你对301和302的理解，以及浏览器缓存机制的理解。</p> <p>301是永久重定向，302是临时重定向。短地址一经生成就不会变化，所以用301是符合http语义的。但 是如果用了301， Google，百度等搜索引擎，搜索的时候会直接展示真实地址，那我们就无法统计到短 地址被点击的次数了，也无法收集用户的Cookie, User Agent 等信息，这些信息可以用来做很多有意思 的大数据分析，也是短网址服务商的主要盈利来源。</p> <p><strong>所以，正确答案是302重定向。</strong></p> <p>预防攻击</p> <p>如果一些别有用心的黑客，短时间内向TinyURL服务器发送大量的请求，会迅速耗光ID，怎么办呢？</p> <p>首先，限制IP的单日请求总数，超过阈值则直接拒绝服务。</p> <p>光限制IP的请求数还不够，因为黑客一般手里有上百万台肉鸡的，IP地址大大的有，所以光限制IP作用不大</p> <p>可以用一台Redis作为缓存服务器，存储的不是 ID-&gt;长网址，而是 长网址-&gt;ID，仅存储一天以内的数 据，用LRU机制进行淘汰。这样，如果黑客大量发同一个长网址过来，直接从缓存服务器里返回短网址即可，他就无法耗光我们的ID了。</p> <h3 id="定时任务调度器"><a href="#定时任务调度器" class="header-anchor">#</a> 定时任务调度器</h3> <p>请实现一个定时任务调度器，有很多任务，每个任务都有一个时间戳，任务会在该时间点开始执行。</p> <p>定时执行任务是一个很常见的需求，例如Uber打车48小时后自动好评，淘宝购物15天后默认好评，等等。</p> <h5 id="方案1-priorityblockingqueue-polling"><a href="#方案1-priorityblockingqueue-polling" class="header-anchor">#</a> <strong>方案1: PriorityBlockingQueue + Polling</strong></h5> <p>我们很快可以想到第一个办法：</p> <ul><li>用一个<code>java.util.concurrent.PriorityBlockingQueue</code> 来作为优先队列。因为我们需要一个优 先队列，又需要线程安全，用<code>PriorityBlockingQueue</code> 再合适不过了。你也可以手工实现一个自 己的 <code>PriorityBlockingQueue</code>，用 <code>java.util.PriorityQueue + ReentrantLock</code>，用一把锁 把这个队列保护起来，就是线程安全的啦</li> <li>对于生产者，可以用一个<code>while(true)</code> ，造一些随机任务塞进去</li> <li>对于消费者，起一个线程，在 <code>while(true)</code> 里每隔几秒检查一下队列，如果有任务，则取出来执行</li></ul> <p>这个方案的确可行，总结起来就是轮询(polling)。轮询通常有个很大的缺点，就是时间间隔不好设置， 间隔太长，任务无法及时处理，间隔太短，会很耗CPU。</p> <h5 id="方案2-priorityblockingqueue-时间差"><a href="#方案2-priorityblockingqueue-时间差" class="header-anchor">#</a> <strong>方案2: PriorityBlockingQueue + 时间差</strong></h5> <p>可以把方案1改进一下， while(true) 里的逻辑变成：</p> <ul><li>偷看一下堆顶的元素，但并不取出来，如果该任务过期了，则取出来</li> <li>如果没过期，则计算一下时间差，然后 sleep()该时间差</li></ul> <p>不再是 sleep() 一个固定间隔了，消除了轮询的缺点。</p> <p>稍等！这个方案其实有个致命的缺陷，导致它比 PiorityBlockingQueue + Polling 更加不可用，这 个缺点是什么呢？。。。假设当前堆顶的任务在100秒后执行，消费者线程peek()偷看到了后，开始 sleep 100秒，这时候一个新的任务插了进来，该任务在10秒后应该执行，但是由于消费者线程要睡眠 100秒，这个新任务无法及时处理</p> <h5 id="方案3-delayqueue"><a href="#方案3-delayqueue" class="header-anchor">#</a> <strong>方案3: DelayQueue</strong></h5> <p>方案2虽然已经不错了，但是还可以优化一下，Java里有一个DelayQueue，完全符合题目的要求。 DelayQueue 设计得非常巧妙，可以看做是一个特化版的 PriorityBlockingQueue ，它把<strong>计算时间差并让消费者等待该时间差的功能集成进了队列</strong>，消费者不需要关心时间差的事情了，直接在 while(true) 里不断 take() 就行了</p> <p>DelayQueue的实现原理见下面的代码。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">PriorityQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">Delayed</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks</span><span class="token punctuation">.</span><span class="token class-name">Condition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks</span><span class="token punctuation">.</span><span class="token class-name">ReentrantLock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> available <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Thread</span> leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">DelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">/**
     * Inserts the specified element into this delay queue.
     *
     * @param e the element to add
     * @return {@code true}
     * @throws NullPointerException if the specified element is null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Retrieves and removes the head of this queue, waiting if necessary
     * until an element with an expired delay is available on this queue.
     *
     * @return the head of this queue
     * @throws InterruptedException {@inheritDoc}
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">E</span> first <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> delay <span class="token operator">=</span> first<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    first <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// don't retain ref while waiting</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span> thisThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        leader <span class="token operator">=</span> thisThread<span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                           available<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> thisThread<span class="token punctuation">)</span>
                                leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这个代码中有几个要点要注意一下。</p> <p><strong>1.put()方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果第一个元素等于刚刚插入进去的元素，说明刚才队列是空的。现在队列里有了一个任务，那么就<strong>应该唤醒所有在等待的消费者线程，避免了方案2的缺点</strong>。将 leader 重置为null，这些消费者之间互相竞争，自然有一个会被选为leader。</p> <p><strong>2.线程leader的作用</strong></p> <p>leader 这个成员有啥作用？DelayQueue的设计其实是一个Leader/Follower模式， leader 就是指向 Leader线程的。该模式可以减少不必要的等待时间，当一个线程是Leader时，它只需要一个时间差；其 他Follower线程则无限等待。比如头节点任务还有5秒就要开始了，那么Leader线程会sleep 5秒，不需要傻傻地等待固定时间间隔。</p> <p>想象一下有个多个消费者线程用take方法去取任务,内部先加锁,然后每个线程都去peek头节点。如果 leader不为空说明已经有线程在取了，让当前消费者无限等待。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
   available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果为空说明没有其他消费者去取任务,设置leader为当前消费者，并让改消费者等待指定的时间，</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thisThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leader <span class="token operator">=</span> thisThread<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
         available<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> thisThread<span class="token punctuation">)</span>
             leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下次循环会走如下分支，取到任务结束，</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>3. take()方法中为什么释放first</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>first <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// don't retain ref while waiting</span>
</code></pre></div><p>我们可以看到 Doug Lea 后面写的注释，那么这行代码有什么用呢？ 如果删除这行代码，会发生什么呢？假设现在有3个消费者线程，</p> <ul><li>线程A进来获取first,然后进入 else 的 else ,设置了leader为当前线程A，并让A等待一段时间</li> <li>线程B进来获取first, 进入else的阻塞操作,然后无限期等待，这时线程B是持有first引用的</li> <li>线程A等待指定时间后被唤醒，获取对象成功，出队，这个对象理应被GC回收，但是它还被线程B持有着，GC链可达，所以不能回收这个first</li> <li>只要线程B无限期的睡眠，那么这个本该被回收的对象就不能被GC销毁掉，那么就会造成内存泄露</li></ul> <p><strong>Task对象</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">Delayed</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">implements</span> <span class="token class-name">Delayed</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> startTime<span class="token punctuation">;</span>  <span class="token comment">// milliseconds</span>
    <span class="token keyword">public</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delay<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> diff <span class="token operator">=</span> startTime <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> unit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>diff<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Delayed</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">)</span> o<span class="token punctuation">)</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;task &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; at &quot;</span> <span class="token operator">+</span> startTime<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>JDK中有一个接口 java.util.concurrent.Delayed ，可以用于表示具有过期时间的元素，刚好可以拿 来表示任务这个概念。</p> <p>生产者</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskProducer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskProducer</span><span class="token punctuation">(</span><span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> delay <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Put &quot;</span> <span class="token operator">+</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                q<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>生产者很简单，就是一个死循环，不断地产生一些是时间随机的任务。</p> <p>消费者</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskConsumer</span><span class="token punctuation">(</span><span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Task</span> task <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Take &quot;</span> <span class="token operator">+</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当 DelayQueue 里没有任务时， TaskConsumer 会无限等待，直到被唤醒，因此它不会消耗CPU。</p> <p>定时任务调度器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskScheduler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskProducer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Producer Thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Consumer Thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>DelayQueue</code>这个方案，每个消费者线程只需要等待所需要的时间差，因此响应速度更快。它内部用了 一个优先队列，所以插入和删除的时间复杂度都是logn。</p> <p>JDK里还有一个<code>ScheduledThreadPoolExecutor</code>，原理跟<code>DelayQueue</code>类似，封装的更完善，平时工作中可以用它，不过面试中，还是拿<code>DelayQueue</code>来讲吧，它封装得比较薄，容易讲清楚原理。</p> <h5 id="方案4-时间轮-hashedwheeltimer"><a href="#方案4-时间轮-hashedwheeltimer" class="header-anchor">#</a> <strong>方案4: 时间轮(HashedWheelTimer)</strong></h5> <p>时间轮(HashedWheelTimer)其实很简单，就是一个循环队列，如下图所示，</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072125288.png" alt="image-20220507212508021"></p> <p>上图是一个长度为8的循环队列，假设该时间轮精度为秒，即每秒走一格，像手表那样，走完一圈就是8 秒。每个格子指向一个任务集合，时间轮无限循环，每转到一个格子，就扫描该格子下面的所有任务， 把时间到期的任务取出来执行。</p> <p>举个例子，假设指针当前正指向格子0，来了一个任务需要4秒后执行，那么这个任务就会放在格子4下 面，如果来了一个任务需要20秒后执行怎么？由于这个循环队列转一圈只需要8秒，这个任务需要多转2 圈，所以这个任务的位置虽然依旧在格子4(20%8+0=4)下面，不过需要多转2圈后才执行。因此每个任务 需要有一个字段记录需圈数，每转一圈就减1，减到0则立刻取出来执行。</p> <p>怎么实现时间轮呢？Netty中已经有了一个时间轮的实现, HashedWheelTimer.java，可以参考它的源代 码。</p> <p>时间轮的优点是性能高，插入和删除的时间复杂度都是O(1)。Linux 内核中的定时器采用的就是这个方 案。</p> <p><strong>Follow up: 如何设计一个分布式的定时任务调度器呢？ 答: Redis ZSet, RabbitMQ等</strong></p> <h3 id="最近一个小时内访问频率最高的10个ip"><a href="#最近一个小时内访问频率最高的10个ip" class="header-anchor">#</a> 最近一个小时内访问频率最高的10个IP</h3> <p>实时输出最近一个小时内访问频率最高的10个IP，要求：</p> <ul><li>实时输出</li> <li>从当前时间向前数的1个小时</li> <li>QPS可能会达到10W/s</li></ul> <p>这道题乍一看很像Top K 频繁项，是不是需要 Lossy Count 或 Count-Min Sketch 之类的算法呢？</p> <p>其实杀鸡焉用牛刀，这道题用不着上述算法，请听我仔细分析。</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072127448.png" alt="image-20220507212718717"></p> <p>有的人问，可不可以用&quot;IP + 时间&quot;作为key, 把所有pair放在单个HashMap里？如果把所有数据放在一个 HashMap里，有两个巨大的缺点，</p> <ul><li>第4步里，怎么淘汰掉一个小时前的pair呢？这时候后台线程只能每隔一秒，全量扫描这个 HashMap里的所有pair,把过期数据删除，这是线性时间复杂度，很慢。</li> <li>这时候HashMap里的key存放的是&quot;IP + 时间&quot;组合成的字符串，占用内存远远大于一个int。而前面 的方案，不用存真正的时间，只需要开一个3600长度的数组来表示一个小时时间窗口。</li></ul> <h3 id="key-value存储引擎"><a href="#key-value存储引擎" class="header-anchor">#</a> key-Value存储引擎</h3> <p>请设计一个Key-Value存储引擎(Design a key-value store)。</p> <p>这是一道频繁出现的题目，个人认为也是一道很好的题目，这题纵深非常深，内行的人可以讲的非常深。</p> <p>首先讲两个术语，数据库和存储引擎。数据库往往是一个比较丰富完整的系统, 提供了SQL查询语言，事务和水平扩展等支持。然而存储引擎则是小而精, 纯粹专注于单机的读/写/存储。一般来说, 数据库底层 往往会使用某种存储引擎。</p> <p>目前开源的KV存储引擎中，RocksDB是流行的一个，MongoDB和MySQL底层可以切换成RocksDB， TiDB底层直接使用了RocksDB。大多数分布式数据库的底层不约而同的都选择了RocksDB。</p> <p>RocksDB最初是从LevelDB进化而来的，我们先从简单一点的LevelDB入手，借鉴它的设计思路。</p> <p>LevelDB整体结构</p> <p>有一个反直觉的事情是，<strong>内存随机写甚至比硬盘的顺序读还要慢</strong>，磁盘随机写就更慢了，说明我们要避 免随机写，最好设计成顺序写。因此好的KV存储引擎，都在尽量避免更新操作，把更新和删除操作转化 为顺序写操作。LevelDB采用了一种SSTable的数据结构来达到这个目的。</p> <p>SSTable(Sorted String Table)就是一组按照key排序好的 key-value对, key和value都是字节数组。 SSTable既可以在内存中，也可以在硬盘中。SSTable底层使用LSM Tree(Log-Structured Merge Tree) 来存放有序的key-value对。</p> <p>LevelDB整体由如下几个组成部分</p> <ol><li>MemTable。即内存中的SSTable，新数据会写入到这里，然后批量写入磁盘，以此提高写的吞吐量。</li> <li>Log文件。写MemTable前会写Log文件，即用WAL(Write Ahead Log)方式记录日志，如果机器突 然掉电，内存中的MemTable丢失了，还可以通过日志恢复数据。WAL日志是很多传统数据库例如 MySQL采用的技术，详细解释可以参考数据库如何用 WAL 保证事务一致性？ - 知乎专栏。</li> <li>.Immutable MemTable。内存中的MemTable达到指定的大小后，将不再接收新数据，同时会有新 的MemTable产生，新数据写入到这个新的MemTable里，Immutable MemTable随后会写入硬 盘，变成一个SST文件。</li> <li>SSTable 文件。即硬盘上的SSTable，文件尾部追加了一块索引，记录key-&gt;offset，提高随机读的 效率。SST文件为Level 0到Level N多层，每一层包含多个SST文件；单个SST文件容量随层次增加 成倍增长；Level0的SST文件由Immutable MemTable直接Dump产生，其他Level的SST文件由其 上一层的文件和本层文件归并产生。</li> <li>Manifest文件。 Manifest文件中记录SST文件在不同Level的分布，单个SST文件的最大最小key， 以及其他一些LevelDB需要的元信息。</li> <li>Current文件。从上面的介绍可以看出，LevelDB启动时的首要任务就是找到当前的Manifest，而 Manifest可能有多个。Current文件简单的记录了当前Manifest的文件名。</li></ol> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072129759.png" alt="image-20220507212945499"></p> <p>LevelDB的一些核心逻辑如下，</p> <ol><li>首先SST文件尾部的索引要放在内存中，这样读索引就不需要一次磁盘IO了</li> <li>所有读要先查看 MemTable ，如果没有再查看内存中的索引</li> <li>所有写操作只能写到 MemTable , 因为SST文件不可修改</li> <li>定期把 Immutable MemTable 写入硬盘，成为 SSTable 文件，同时新建一个 MemTable 会继 续接收新来的写操作</li> <li>定期对 SSTable 文件进行合并</li> <li>由于硬盘上的 SSTable 文件是不可修改的，那怎么更新和删除数据呢？对于更新操作，追加 一个新的key-value对到文件尾部，由于读 SSTable 文件是从前向后读的，所以新数据会最先被读到；对于删除操作，追加“墓碑”值(tombstone)，表示删除该key，在定期合并 SSTable 文件时丢弃这些key, 即可删除这些key</li></ol> <p><strong>Manifest文件</strong></p> <p>Manifest文件记录各个SSTable各个文件的管理信息，比如该SST文件处于哪个Level，文件名称叫 啥，最小key和最大key各自是多少，如下图所示</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072131015.png" alt="image-20220507213107745"></p> <p><strong>Log文件</strong></p> <p>Log文件主要作用是系统发生故障时，能够保证不会丢失数据。因为在数据写入内存中的 MemTable之前，会先写入Log文件，这样即使系统发生故障，MemTable中的数据没有来得及 Dump到磁盘，LevelDB也可以根据log文件恢复内存中的MemTable，不会造成系统丢失数据。这 个方式就叫做 WAL(Write Ahead Log)，很多传统数据库例如MySQL也使用了WAL技术来记录日志。</p> <p>每个Log文件由多个block组成，每个block大小为32K，读取和写入以block为基本单位。下图所示的Log文件包含3个Block</p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072131851.png" alt="image-20220507213151602"></p> <p><img src="https://guli-file-fxy.oss-cn-shanghai.aliyuncs.com/img/202205072132827.png" alt="image-20220507213200525"></p> <p>MemTable 是内存中的数据结构，存储的内容跟硬盘上的SSTable一样，只是格式不一样。 Immutable MemTable的内存结构和Memtable是完全一样的，区别仅仅在于它是只读的，而 MemTable则是允许写入和读取的。当MemTable写入的数据占用内存到达指定大小，则自动转换 为Immutable Memtable，等待Dump到磁盘中，系统会自动生成一个新的MemTable供写操作写 入新数据，理解了MemTable，那么Immutable MemTable自然不在话下。</p> <p>MemTable里的数据是按照key有序的，因此当插入新数据时，需要把这个key-value对插入到合适 的位置上，以保持key有序性。MemTable底层的核心数据结构是一个跳表(Skip List)。跳表是红黑 树的一种替代数据结构，具有更高的写入速度，而且实现起来更加简单，请参考跳表(Skip List)。</p> <p>前面我们介绍了LevelDB的一些内存数据结构和文件，这里开始介绍一些动态操作，例如读取，写入，更新和删除数据，分层合并，错误恢复等操作。</p> <p>添加、更新和删除数据</p> <p>LevelDB写入新数据时，具体分为两个步骤：</p> <ol><li>将这个操作顺序追加到log文件末尾。尽管这是一个磁盘操作，但是文件的顺序写入效率还是跟高的，所以不会降低写入的速度</li> <li>如果log文件写入成功，那么将这条key-value记录插入到内存中MemTable。</li></ol> <p>LevelDB更新一条记录时，并不会本地修改SST文件，而是会作为一条新数据写入MemTable，随后会写入SST文件，在SST文件合并过程中，新数据会处于文件尾部，而读取操作是从文件尾部倒着 开始读的，所以新值一定会最先被读到。</p> <p>LevelDB删除一条记录时，也不会修改SST文件，而是用一个特殊值(墓碑值，tombstone)作为 value，将这个key-value对追加到SST文件尾部，在SST文件合并过程中，这种值的key都会被忽略掉。</p> <p>核心思想就是把写操作转换为顺序追加，从而提高了写的效率。</p> <p><strong>读取数据</strong></p> <p>读操作使用了如下几个手段进行优化：</p> <ul><li>MemTable + SkipList</li> <li>Binary Search(通过 manifest 文件)</li> <li>页缓存</li> <li>bloom filter</li> <li>周期性分层合并</li></ul> <h3 id="top-k频繁项"><a href="#top-k频繁项" class="header-anchor">#</a> Top k频繁项</h3> <p>寻找数据流中出现最频繁的k个元素(find top k frequent items in a data stream)。这个问题也称为 Heavy Hitters.</p> <p>这题也是从实践中提炼而来的，例如搜索引擎的热搜榜，找出访问网站次数最多的前10个IP地址，等等。</p> <h5 id="方案1-hashmap-heap"><a href="#方案1-hashmap-heap" class="header-anchor">#</a> 方案1: HashMap + Heap</h5> <p>用一个 HashMap ，存放所有元素出现的次数，用一个小根堆，容量为k，存放目前出 现过的最频繁的k个元素，</p> <ol><li>每次从数据流来一个元素，如果在HashMap里已存在，则把对应的计数器增1，如果不存在，则插入，计数器初始化为1</li> <li>在堆里查找该元素，如果找到，把堆里的计数器也增1，并调整堆；如果没有找到，把这个元素的 次数跟堆顶元素比较，如果大于堆丁元素的出现次数，则把堆丁元素替换为该元素，并调整堆</li> <li>空间复杂度 O(n) 。HashMap需要存放下所有元素，需要 O(n) 的空间，堆需要存放k个元素，需 要 O(k) 的空间，跟 O(n) 相比可以忽略不急，总的时间复杂度是 O(n)</li> <li>时间复杂度 O(n) 。每次来一个新元素，需要在HashMap里查找一下，需要 O(1) 的时间；然后要 在堆里查找一下， O(k) 的时间，有可能需要调堆，又需要 O(logk) 的时间，总的时间复杂度是 O(n(k+logk)) ，k是常量，所以可以看做是O(n)。</li></ol> <p>如果元素数量巨大，单机内存存不下，怎么办？ 有两个办法，见方案2和3。</p> <h5 id="方案2-多机hashmap-heap"><a href="#方案2-多机hashmap-heap" class="header-anchor">#</a> 方案2: 多机HashMap + Heap</h5> <ul><li>可以把数据进行分片。假设有8台机器，第1台机器只处理 hash(elem)%8 == 0 的元素，第2台机器 只处理 hash(elem)%8==1 的元素，以此类推。</li> <li>每台机器都有一个HashMap和一个 Heap, 各自独立计算出 top k 的元素</li> <li>把每台机器的Heap，通过网络汇总到一台机器上，将多个Heap合并成一个Heap，就可以计算出 总的 top k 个元素了</li></ul> <h5 id="方案3-count-min-sketch-heap"><a href="#方案3-count-min-sketch-heap" class="header-anchor">#</a> 方案3: Count-Min Sketch + Heap</h5> <p>既然方案1中的HashMap太大，内存装不小，那么可以用Count-Min Sketch算法代替HashMap，</p> <ul><li>在数据流不断流入的过程中，维护一个标准的Count-Min Sketch 二维数组</li> <li>维护一个小根堆，容量为k</li> <li>每次来一个新元素，
<ul><li>将相应的sketch增1</li> <li>在堆中查找该元素，如果找到，把堆里的计数器也增1，并调整堆；如果没有找到，把这个元 素的sketch作为钙元素的频率的近似值，跟堆顶元素比较，如果大于堆丁元素的频率，则把堆顶元素替换为该元素，并调整堆</li></ul></li></ul> <p>这个方法的时间复杂度和空间复杂度如下：</p> <ul><li>空间复杂度 O(dm) 。m是二维数组的列数，d是二维数组的行数，堆需要 O(k) 的空间，不过k通常很小，堆的空间可以忽略不计</li> <li>时间复杂度 O(nlogk) 。每次来一个新元素，需要在二维数组里查找一下，需要 O(1) 的时间；然 后要在堆里查找一下， O(logk) 的时间，有可能需要调堆，又需要 O(logk) 的时间，总的时间复杂度是 O(nlogk) 。</li></ul> <h5 id="方案4-lossy-counting"><a href="#方案4-lossy-counting" class="header-anchor">#</a> 方案4: Lossy Counting</h5> <p>Lossy Couting 算法流程：</p> <ul><li>建立一个HashMap，用于存放每个元素的出现次数</li> <li>建立一个窗口（窗口的大小由错误率决定，后面具体讨论）</li> <li>等待数据流不断流进这个窗口，直到窗口满了，开始统计每个元素出现的频率，统计结束后，每个元素的频率减1，然后将出现次数为0的元素从HashMap中删除</li> <li>返回第2步，不断循环</li></ul> <p>Lossy Counting 背后朴素的思想是，出现频率高的元素，不太可能减一后变成0，如果某个元素在某个 窗口内降到了0，说明它不太可能是高频元素，可以不再跟踪它的计数器了。随着处理的窗口越来越多， HashMap也会不断增长，同时HashMap里的低频元素会被清理出去，这样内存占用会保持在一个很低的水平。</p> <p>很显然，Lossy Counting 算法是个近似算法，但它的错误率是可以在数学上证明它的边界的。假设要求 错误率不大于ε，那么窗口大小为1/ε，对于长度为N的流，有N／（1/ε）＝εN 个窗口，由于每个窗口结 束时减一了，那么频率最多被少计数了窗口个数εN。</p> <p>该算法只需要一遍扫描，所以时间复杂度是 O(n) 。</p> <p>该算法的内存占用，主要在于那个HashMap, Gurmeet Singh Manku 在他的论文里，证明了HashMap 里最多有 1/ε log (εN) 个元素，所以空间复杂度是 O(1/ε log (εN)) 。</p> <h3 id="网站大文件上传"><a href="#网站大文件上传" class="header-anchor">#</a> 网站大文件上传</h3> <p>如果你的项目涉及到文件上传的话，面试官很可能会问你这个问题。</p> <p>我们先看第一个场景：<strong>大文件上传中途，突然失败！</strong></p> <p>试想一个，你想上传一个 5g 的视频，上传进度到 99% 的时候，特么的，突然网络断了，这个时候，你发现自己竟然需要重新上传。我就问你抓狂不？</p> <p><strong>有没有解决办法呢？</strong> 答案就是：<strong>分片上传！</strong></p> <p><strong>什么是分片上传呢？</strong> 简单来说，我们只需要先将文件切分成多个文件分片（就像我下面绘制的图片所展示的那样），然后再上传这些小的文件分片。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/0d9f29f1023e9c9688dbe7d7df97fc12.png" alt="img"></p> <p>前端发送了所有文件分片之后，服务端再将这些文件分片进行合并即可。</p> <p>使用分片上传主要有下面 2 点好处：</p> <ol><li><strong>断点续传</strong> ：上传文件中途暂停或失败（比如遇到网络问题）之后，不需要重新上传，只需要上传哪些未成功上传的文件分片即可。所以，分片上传是断点续传的基础。</li> <li><strong>多线程上传</strong> ：我们可以通过多线程同时对一个文件的多个文件分片进行上传，这样的话就大大加快的文件上传的速度。</li></ol> <p><strong>前端怎么生成文件分片呢？后端如何合并文件分片呢？</strong></p> <p>前端可以通过 <strong><code>Blob.slice()</code></strong> 方法来对文件进行切割（<code>File</code> 对象是继承 <code>Blob</code> 对象的，因此 <code>File</code> 对象也有 <code>slice()</code> 方法）。</p> <p>生成文件切片的示例代码如下：</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/7ddfd1d732eb7605f6ca0ebff34dc5f6.png" alt="img"></p> <p><strong><code>RandomAccessFile</code></strong> 类可以帮助我们合并文件分片，示例代码如下：</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/fdda9509919179ad9f3ca9b62314613f.png" alt="img"></p> <p><strong>何为秒传？</strong></p> <p>秒传说的就是我们在上传某个文件的时候，首先根据文件的唯一标识判断一下服务端是否已经上传过该文件，如果上传过的话，直接就返回给用户文件上传成功即可。</p> <p>一般情况下，这个唯一标识都是通过对文件的名称、最后修改时间等信息取 MD5 值得到的，这个可以通过使用 <code>spark-md5</code> 这个库来生成。</p> <p>需要注意的是：你不能根据文件名就决定文件是否已经上传到服务端，因为很可能存在文件名相同，但是，内容不同的情况。另外，体验更好的是文件内容不变，唯一标识就不应该改变。因此，我们可以根据文件的内容来计算 MD5 值。</p> <p>另外，还存在一种情况是我们要上传的文件已经上传了部分文件切片到服务端。这个时候，我们直接返回已上传的切片列表给前端即可。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/345e31afd324594ccba9623ceca3fefb.png" alt="img"></p> <p>然后，前端再将剩余未上传的分片上传到服务端。</p> <p>我简单画了一张图描述一下断点续传和秒传。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/72c617e781eae3a378dfec9d32b6b4f8.png" alt="img"></p> <h3 id="如何设计微博-feed-流-信息流系统"><a href="#如何设计微博-feed-流-信息流系统" class="header-anchor">#</a> 如何设计微博 Feed 流/信息流系统</h3> <p>“如何设计微博 Feed 流/信息流系统？ ”是一道比较常见的系统设计问题，面试中比较常见。</p> <p>这篇文章简单谈谈我的看法。个人能力有限，有些地方大家可以结合自己的经验自行扩展！爱你们哦！</p> <p><strong>下面是正文！</strong></p> <p>Feed 流是社交和资讯平台不可缺少的重要组成。TimeLine 时期，Feed 流推送的机制完全基于时间，比如朋友圈动态、几年前的微信订阅号就是这种机制。</p> <p>现在的 Feed 流主要是基于智能化/个性化的推荐，简单来说，就是你喜欢什么我就给你推荐什么。这样的话，人们被推送的信息会极大地由自己的个人兴趣主导，你自己所处的信息世界就像桎梏于蚕茧一般的“茧房”中一样。这也就是“信息茧房”所表达的意思。</p> <h5 id="feed-流基础"><a href="#feed-流基础" class="header-anchor">#</a> Feed 流基础</h5> <h5 id="何为-feed-流？"><a href="#何为-feed-流？" class="header-anchor">#</a> 何为 Feed 流？</h5> <p>简单来说就是能够实时/智能推送信息的数据流。像咱们的朋友圈动态（timeline）、知乎的推荐（智能化推荐 ）、你订阅的 Up 主的动态（timeline）都属于 <strong>Feed 流</strong>。</p> <h5 id="几种常见的-feed-流形式"><a href="#几种常见的-feed-流形式" class="header-anchor">#</a> 几种常见的 Feed 流形式</h5> <p>我总结了 3 种常见的 Feed 流形式。</p> <h6 id="纯智能推荐"><a href="#纯智能推荐" class="header-anchor">#</a> 纯智能推荐</h6> <p>你看到的内容完全是基于你看过的内容而推荐的，比较典型的产品有头条首页推荐、知乎首页推荐。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/699d4f66cc0091c090671d0839a3c1c0.png" alt="img"></p> <p>智能推荐需要依赖 <strong>推荐系统</strong> ，推荐质量的好坏和推荐算法有非常大的关系。</p> <p>推荐系统的相关文献把它们分成三类：<strong>协同过滤</strong>（仅使用用户与商品的交互信息生成推荐）系统、<strong>基于内容</strong>（利用用户偏好和／或商品偏好）的系统和 <strong>混合推荐模型</strong>（使用交互信息、用户和商品的元数据）的系统。</p> <p>另外，随着深度学习应用的爆发式发展，特别是在计算机视觉、自然语言处理和语音方面的进展，基于深度学习的推荐系统越来越引发大家的关注。循环神经网络（RNN）理论上能够有效地对用户偏好和物品属性的动态性进行建模，基于当前的趋势，预测未来的行为。</p> <h6 id="纯-timeline"><a href="#纯-timeline" class="header-anchor">#</a> 纯 Timeline</h6> <p>你看到的内容完全按照时间来排序，比较典型的产品有微信朋友圈、QQ 空间、微博关注者动态。</p> <p>微信朋友圈：</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/5001bab8a83890c875d107608623ab28.png" alt="img"></p> <p>微博关注者动态：</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/61dda8dd35201ed58c9220268f632a6b.png" alt="img"></p> <p>纯 Timeline 这种方式实现起来最简单，直接按照时间排序就行了。</p> <p>纯 Timeline 这种形式更适用于好友社交领域，用户关注更多的是人发出的内容，而不仅仅是内容。</p> <h6 id="智能推荐-timeline"><a href="#智能推荐-timeline" class="header-anchor">#</a> 智能推荐+Timeline</h6> <p>智能推荐+Timeline 这个也是目前我觉得比较好的一种方式，实现起来比较简单，同时又能一定程度地避免 “信息茧房” 的问题。</p> <h5 id="设计-feed-流系统的注意事项"><a href="#设计-feed-流系统的注意事项" class="header-anchor">#</a> 设计 Feed 流系统的注意事项</h5> <ol><li><strong>实时性</strong> ：你关注的人发了微博信息之后，信息需要在短时间之内出现在你的信息流中。</li> <li><strong>高并发</strong> ：信息流是微博的主体模块，是用户进入到微博之后最先看到的模块，因此它的并发请求量是最高的，可以达到每秒几十万次请求。</li> <li><strong>性能</strong> ： 信息流拉取性能直接影响用户的使用体验。微博信息流系统中需要聚合的数据非常多。聚合这么多的数据就需要查询多次缓存、数据库、计数器，而在每秒几十万次的请求下，如何保证在 100ms 之内完成这些查询操作，展示微博的信息流呢？这是微博信息流系统最复杂之处，也是技术上最大的挑战。</li> <li>......</li></ol> <h5 id="feed-流架构设计"><a href="#feed-流架构设计" class="header-anchor">#</a> Feed 流架构设计</h5> <p>我们这里以 <strong>微博关注者动态</strong> 为例。</p> <h5 id="feed-流的-3-种推送模式"><a href="#feed-流的-3-种推送模式" class="header-anchor">#</a> Feed 流的 3 种推送模式</h5> <h6 id="推模式"><a href="#推模式" class="header-anchor">#</a> 推模式</h6> <p>当一个用户发送一个动态（比如微博、视频）之后，主动将这个动态推送给其他相关用户（比如粉丝）。</p> <p>推模式下，我们需要将这个动态插入到每位粉丝对应的 feed 表中，这个存储成本是比较高的。尤其是对于粉丝数量比较多的大 V 来说，每发一条动态，需要存储的数据量实在太大。</p> <p>假如狗蛋，有 n 个粉丝 1、2 ~ n。那么，狗蛋发一条微博时，我们需要执行的 SQL 语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> outbox<span class="token punctuation">(</span>userId<span class="token punctuation">,</span> feedId<span class="token punctuation">,</span> create_time<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&quot;goudan&quot;</span><span class="token punctuation">,</span> $feedId<span class="token punctuation">,</span> $<span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入用户狗蛋的发件箱</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> inbox<span class="token punctuation">(</span>userId<span class="token punctuation">,</span> feedId<span class="token punctuation">,</span> create_time<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> $feedId<span class="token punctuation">,</span> $<span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入用户2的收件箱</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> inbox<span class="token punctuation">(</span>userId<span class="token punctuation">,</span> feedId<span class="token punctuation">,</span> create_time<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> $feedId<span class="token punctuation">,</span> $<span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入用户n的收件箱</span>
</code></pre></div><p>当我们要查询用户 n 的信息流时，只需要执行下面这条 SQL 就可以了：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> feedId <span class="token keyword">from</span> inbox <span class="token keyword">where</span> userId <span class="token operator">=</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>可以很明显的看出，推模式最大的问题就是写入数据库的操作太多。</p> <p>正常情况下，一个微博用户的粉丝大概在 150 左右，挨个写入也还好。不过，微博大 V 的粉丝可能在几百万，几千万，如果挨个给每个写入一条数据的话，是肯定不能接受的！因此，推模式不适合关注者粉丝过多的场景。</p> <h6 id="拉模式"><a href="#拉模式" class="header-anchor">#</a> 拉模式</h6> <p>不同于推模式，拉模式下我们是自己主动去拉取动态（拉取你关注的人的动态），然后将这些动态根据相关指标（比如时间、热度）进行实时聚合。</p> <p>拉模式存储成本虽然降低，但是查询和聚合这两个操作的成本会比较高。尤其是对于单个用户关注了很多人的情况来说，你需要定时获取他关注的所有人的动态然后再做聚合，这个成本可想而知。</p> <p>另外，拉模式下的数据流的实时性要比推模式差的。</p> <h6 id="推垃结合模式"><a href="#推垃结合模式" class="header-anchor">#</a> 推垃结合模式</h6> <p>推拉结合的核心是针对微博大 V 和不活跃用户特殊处理。</p> <p>首先，我们需要区分出系统哪些用户属于微博大 V（10w 粉丝以上？）。其次，我们需要根据登录行为来判断哪些用户属于不活跃用户。</p> <p>有了这些数据之后，就好办了！当微博大 V 发送微博的时候，我们仅仅将这条微博写入到活跃用户，不活跃的用户自己去拉取。示意图如下（图片来自：《高并发系统设计 40 问》）：</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/587f58dd2d32a59510706f9c8a031f4f.png" alt="img"></p> <p>推拉结合非常适合用户粉丝数比较大的场景。</p> <h5 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h5> <p>我们的存储的数据量会比较大，所以，存储库必须要满足可以水平扩展。</p> <p>一般情况，通用的存储方案就是 <strong>MySQL + Redis</strong> 。MySQL 永久保存数据， Redis 作为缓存提高热点数据的访问速度。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/5bb5862e85941141de073e6e08a4fce4.png" alt="img"></p> <p><strong>如果缓存的数据量太大怎么办?</strong> 我们可以考虑使用<strong>Redis Cluster</strong>，也就是 Redis 集群。Redis Cluster 可以帮助我们解决 Redis 大数据量缓存的问题，并且，也方便我们进行横向拓展（增加 Redis 机器）。</p> <p>为了提高系统的并发，我们可以考虑对数据进行 <strong>读写分离</strong> 和 <strong>分库分表</strong> 。</p> <p>读写分离主要是为了将数据库的读和写操作分不到不同的数据库节点上。主服务器负责写，从服务器负责读。另外，一主一从或者一主多从都可以。读写分离可以大幅提高读性能，小幅提高写的性能。因此，读写分离更适合单机并发读请求比较多的场景。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/e1c8a28aa60ff84cac256d40d39e88c2.png" alt="读写分离"></p> <p>读写分离</p> <p>分库分表是为了解决由于库、表数据量过大，而导致数据库性能持续下降的问题。常见的分库分表工具有：<code>sharding-jdbc</code>（当当）、<code>TSharding</code>（蘑菇街）、<code>MyCAT</code>（基于 Cobar）、<code>Cobar</code>（阿里巴巴）...。 推荐使用 <code>sharding-jdbc</code>。 因为，<code>sharding-jdbc</code> 是一款轻量级 <code>Java</code> 框架，以 <code>jar</code> 包形式提供服务，不要我们做额外的运维工作，并且兼容性也很好。</p> <p><a href="https://time.geekbang.org/column/intro/100006601?code=i00Nq3pHUcUj04ZWy70NCRl%2FD2Lfj8GVzcGzZ3Wf5Ug%3D" target="_blank" rel="noopener noreferrer">《从零开始学架构》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的有一张图片对于垂直拆分和水平拆分的描述还挺直观的。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/b2792b8ddbff47e85cc8f2279fecc73b.jpg" alt="img"></p> <p>另外，如果觉得分库分表比较麻烦的话，可以考虑使用 <a href="https://docs.pingcap.com/zh/tidb/stable" target="_blank" rel="noopener noreferrer">TiDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这类分布式数据库。TiDB 是国内 PingCAP 团队开发的一个分布式 SQL 数据库。其灵感来自于 Google 的 F1, TiDB 支持包括传统 RDBMS 和 NoSQL 的特性，具备水平扩容或者缩容、金融级高可用。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/fb6fce08fb9a3fe06362a9aceab5420e.png" alt="img"></p> <h3 id="如何设计一个排行榜"><a href="#如何设计一个排行榜" class="header-anchor">#</a> 如何设计一个排行榜</h3> <p>排行榜到处可见，比如直播间送礼物的排行榜、朋友圈的微信步数排行榜、王者荣耀中的段位排行榜等等。</p> <p><img src="https://images.xiaozhuanlan.com/photo/2021/5ed1b5437d7213579e06b9bc1b2ff349.png" alt="img"></p> <p>今天让我们从程序设计的角度，来看看如何设计一个排行榜！</p> <p>我们先从最基础的实现方式来说起。</p> <h5 id="mysql-的-order-by-关键字"><a href="#mysql-的-order-by-关键字" class="header-anchor">#</a> MySQL 的 ORDER BY 关键字</h5> <p>第一种要介绍的实现方式就是直接使用 MySQL 的 <code>ORDER BY</code> 关键字。 <code>ORDER BY</code> 关键字可以对查询出来的数据按照指定的字段进行排序。</p> <p>我相信但凡是学过 MySQL 的人，一定都用过 <code>ORDER BY</code> 关键字！没用过的，先不要看下面的文章了，麻烦默默反思 3 分钟。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> table_name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">ASC</span><span class="token operator">/</span><span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre></div><p>我之前在一个用户数据量不大（6w 用户左右）并且排序需求并不复杂的项目中使用的就是这种方法。</p> <p>这种方式的优缺点也比较明显。<strong>好处是比较简单，不需要引入额外的组件，成本比较低。坏处就是每次生成排行榜都比较耗时，对数据库的性能消耗非常之大，数据量一大，业务场景稍微复杂一点就顶不住了。</strong></p> <p>我们这里创建一个名为 <code>cus_order</code> 的表，来实际测试一下这种排序方式。为了测试方便， <code>cus_order</code> 这张表只有 <code>id</code>、<code>score</code>、<code>name</code>这 3 个字段。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>cus_order<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">100000</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre></div><p>我们定义一个简单的存储过程（PROCEDURE）来插入 100w 测试数据。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DEFINER</span><span class="token operator">=</span><span class="token punctuation">`</span>root<span class="token punctuation">`</span><span class="token variable">@`%`</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>BatchinsertDataToCusOder<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token operator">IN</span> start_num <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token operator">IN</span> max_num <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
      <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">default</span> start_num<span class="token punctuation">;</span>
      <span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> max_num <span class="token keyword">DO</span>
          <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token punctuation">`</span>cus_order<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
          <span class="token keyword">values</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">,</span>CONCAT<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>存储过程定义完成之后，我们执行存储过程即可！</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CALL</span> BatchinsertDataToCusOder<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 插入100w+的随机数据</span>
</code></pre></div><p>等待一会，100w 的测试数据就插入完成了！</p> <p>为了能够对这 100w 数据按照 <code>score</code> 进行排序，我们需要执行下面的 SQL 语句。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>cus_order<span class="token punctuation">`</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span><span class="token comment">#降序排序</span>
</code></pre></div><p>为了能够查看这套 SQL 语句的执行时间，我们需要通过<code>show profiles</code>命令。</p> <p>不过，请确保你的 <code>profiling</code> 是开启（on）的状态（可以通过 <code>show variables</code> 命令查看）。</p> <p>默认情况下， <code>profiling</code> 是关闭（off）的状态，你直接通过<code>set @@profiling=1</code>命令即可开启。</p> <p>然后，我们就查询到了具体的执行速度。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Query_ID&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Duration&quot;</span><span class="token operator">:</span> <span class="token number">3.63526325</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT `score`,`name` FROM `cus_order` ORDER BY `score` DESC&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，一共耗时了接近 4 s。</p> <p><strong>如何优化呢？</strong> <strong>加索引并且限制排序数据量</strong> 是一种比较常见的优化方式。</p> <p>我们对 <code>score</code> 字段加字段，并限制只排序 <code>score</code> 排名前 500 的数据。</p> <p>这个时候，我们再执行下面的 SQL 语句，速度就快了很多，只需要 0.01 秒就排序了前 500 名的数据。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Query_ID&quot;</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Duration&quot;</span><span class="token operator">:</span> <span class="token number">0.0102915</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT `score`,`name` FROM `cus_order` ORDER BY `score` DESC LIMIT 500&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然了，这只是一个最简单的场景，实际项目中的复杂度要比我这里列举的例子复杂很多，执行速度也会慢很多。</p> <p>不过，<strong>能不用 MySQL 的 ORDER BY 关键字还是要看具体的业务场景。如果说你的项目需要排序数据量比较小并且业务场景不复杂的话（比如你对你博客的所有文章按照阅读量来排序），我觉得直接使用 MySQL 的 <code>ORDER BY</code> 关键字就可以了。</strong></p> <h5 id="redis-的-sorted-set"><a href="#redis-的-sorted-set" class="header-anchor">#</a> Redis 的 sorted set</h5> <p><img src="https://images.xiaozhuanlan.com/photo/2021/061065c539360ede10c2b511934e72f1.png" alt="img"></p> <p>了解过 Redis 常见数据结构的小伙伴，都知道 Redis 中有一个叫做 <code>sorted set</code> 的数据结构经常被用在各种排行榜的场景下。</p> <p>通过 <code>sorted set</code> ，我们能够轻松应对百万级别的用户数据排序。这简直就是专门为排行榜设计的数据结构啊！</p> <p>Redis 中 <code>sorted set</code> 有点类似于 Java 中的 <code>TreeSet</code> 和 <code>HashMap</code> 的结合体，<code>sorted set</code> 中的数据会按照权重参数 <code>score</code> 的值进行排序。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ZADD key <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span> <span class="token punctuation">[</span>GT<span class="token operator">|</span>LT<span class="token punctuation">]</span> <span class="token punctuation">[</span>CH<span class="token punctuation">]</span> <span class="token punctuation">[</span>INCR<span class="token punctuation">]</span> score member <span class="token punctuation">[</span>score member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre></div><table><thead><tr><th style="text-align:left;">User</th> <th style="text-align:left;">Score</th></tr></thead> <tbody><tr><td style="text-align:left;">user1</td> <td style="text-align:left;">112.0</td></tr> <tr><td style="text-align:left;">user2</td> <td style="text-align:left;">100.0</td></tr> <tr><td style="text-align:left;">user3</td> <td style="text-align:left;">123.0</td></tr> <tr><td style="text-align:left;">user4</td> <td style="text-align:left;">100.0</td></tr> <tr><td style="text-align:left;">user5</td> <td style="text-align:left;">33.0</td></tr> <tr><td style="text-align:left;">user6</td> <td style="text-align:left;">993.0</td></tr></tbody></table> <p>我们这里简单来演示一下。我们把上表中的数据添加到<code>sorted set</code>中。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 通过 zadd 命令添加了 6 个元素到 cus_order_set 中</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD cus_order_set <span class="token number">112.0</span> user1 <span class="token number">100.0</span> user2 <span class="token number">123.0</span> user3 <span class="token number">100.0</span> user4 <span class="token number">33.0</span> user5 <span class="token number">993.0</span> user6
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
</code></pre></div><p><img src="https://images.xiaozhuanlan.com/photo/2021/76f52695316b92b44cdce03c4e030009.png" alt="img"></p> <p><code>sorted set</code> 基本可以满足大部分排行榜的场景。</p> <p><strong>如果我们要查看包含所有用户的排行榜怎么办？</strong> 通过 <code>ZRANGE</code> (从小到大排序) / <code>ZREVRANGE</code> （从大到小排序）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># -1 代表的是全部的用户数据，</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZREVRANGE cus_order_set <span class="token number">0</span> -1
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;user6&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;user3&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;user1&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;user4&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;user2&quot;</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;user5&quot;</span>
</code></pre></div><p><strong>如果我们要查看只包含前 3 名的排行榜怎么办？</strong> 限定范围区间即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 0 为 start  2 为 stop</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZREVRANGE cus_order_set <span class="token number">0</span> <span class="token number">2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;user6&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;user3&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;user1&quot;</span>
</code></pre></div><p><strong>如果我们需要查询某个用户的分数怎么办呢？</strong> 通过 <code>ZSCORE</code> 命令即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZSCORE  cus_order_set <span class="token string">&quot;user1&quot;</span>
<span class="token string">&quot;112&quot;</span>
</code></pre></div><p><strong>如果我们需要查询某个用户的排名怎么办呢？</strong> 通过 <code>ZREVRANK</code> 命令即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZREVRANK  cus_order_set <span class="token string">&quot;user3&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span> <span class="token comment"># user3 排名第2</span>
</code></pre></div><p><strong>如何对用户的排名数据进行更新呢？</strong> 通过 <code>ZINCRBY</code>命令即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 对 user1 的分数加2</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY cus_order_set +2 <span class="token string">&quot;user1&quot;</span>
<span class="token string">&quot;114&quot;</span>
<span class="token comment"># 对 user1 的分数减1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY cus_order_set -1 <span class="token string">&quot;user1&quot;</span>
<span class="token string">&quot;113&quot;</span>
<span class="token comment"># 查看 user1 的分数</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZSCORE  cus_order_set <span class="token string">&quot;user1&quot;</span>
<span class="token string">&quot;113&quot;</span>
</code></pre></div><p>除了我上面提到的之外，还有一些其他的命令来帮助你解决更多排行榜场景的需求，想要深入研究的小伙伴可以仔细学习哦！</p> <p>不过，需要注意的一点是：<strong>Redis 中只保存了排行榜展示所需的数据，用户的具体相信数据的话，还是需要去对应的数据库（比如 MySQL）中查。</strong></p> <p><strong>你以为这样就完事了？</strong> 不存在的！还有一些无法仅仅通过 Redis 提供的命令解决的场景。</p> <p>比如，<strong>如何实现多条件排序？</strong> 其实，答案也比较简单，对于大部分场景，我们直接对 <code>score</code> 值做文章即可。</p> <p>更具体点的话就是，我们根据特定的条件来拼接 <code>score</code> 值即可。比如我们还要加上时间先后条件的话，直接在<code>score</code> 值添加上时间戳即可。</p> <p>再比如，<strong>如何实现指定日期（比如最近 7 天）的用户数据排序？</strong></p> <p>我说一种比较简单的方法：我们把每一天的数据都按照日期为名字，比如 20350305 就代表 2035 年 3 月 5 号。</p> <p>如果我们需要查询最近 n 天的排行榜数据的话，直接 <code>ZUNIONSTORE</code>来求 n 个 <code>sorted set</code> 的并集即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ZUNIONSTORE last_n_days n <span class="token number">20350305</span> <span class="token number">20350306</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre></div><p>我不知道大家看懂了没有，我这里还是简单地造一些数据模拟一下吧！</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 分别添加了 3 天的数据</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD <span class="token number">20350305</span> <span class="token number">112.0</span> user1 <span class="token number">100.0</span> user2 <span class="token number">123.0</span> user3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD <span class="token number">20350306</span> <span class="token number">100.0</span> user4
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD <span class="token number">20350307</span> <span class="token number">33.0</span> user5 <span class="token number">993.0</span> user6
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
</code></pre></div><p>通过 <code>ZUNIONSTORE</code> 命令来查看最近 3 天的排行榜情况：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZUNIONSTORE last_n_days <span class="token number">3</span> <span class="token number">20350305</span> <span class="token number">20350306</span> <span class="token number">20350307</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
</code></pre></div><p>现在，这 3 天的数据都集中在了 <code>last_n_days</code> 中。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZREVRANGE last_n_days <span class="token number">0</span> -1
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;user6&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;user3&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;user1&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;user4&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;user2&quot;</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;user5&quot;</span>
</code></pre></div><p>如果一个用户同时在多个 <code>sorted set</code> 中的话，它最终的 <code>score</code> 值就等于这些 <code>sorted set</code> 中该用户的 <code>score</code> 值之和。</p> <p>既然可以求并集，那必然也可以求交集。你可以通过 <code>ZINTERSTORE</code> 命令来求多个 n 个 <code>sorted set</code> 的交集。</p> <p><strong>有哪些场景可以用到多个<code>sorted set</code> 的交集呢？</strong> 比如每日打卡的场景，你对某一段时间每天打卡的人进行排序。</p> <p>这个命令还有一个常用的权重参数 <code>weights</code> （默认为 1）。在进行并集/交集的过程中，每个集合中的元素会将自己的 <code>score</code> *<code>weights</code> 。</p> <p>我下面演示一下这个参数的作用。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># staff_set 存放员工的排名信息</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD staff_set <span class="token number">3.0</span> staff1 <span class="token number">4.0</span> staff2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
<span class="token comment"># staff_set 存放管理者的排名信息</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZADD manager_set <span class="token number">1.0</span> manager1 <span class="token number">2.0</span> manager2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
</code></pre></div><p>如果，我们需要将员工和管理者放在一起比较，不过，两者权重分别为 1 和 3。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># staff_set 的权重为1 manager_set的权重为3</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZUNIONSTORE all_user_set <span class="token number">2</span> staff_set manager_set WEIGHTS <span class="token number">1</span> <span class="token number">3</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>
</code></pre></div><p>最终排序的结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZREVRANGE all_user_set <span class="token number">0</span> -1
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;manager2&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;staff2&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;staff1&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;manager1&quot;</span>
</code></pre></div><h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <p>上面我一共提到了两种设计排行榜的方法：</p> <ol><li>MySQL 的 ORDER BY 关键字</li> <li>Redis 的 sorted set</li></ol> <p>其实，这两种没有孰好孰坏，还是要看具体的业务场景。如果说你的项目需要排序数据量比较小并且业务场景不复杂的话（比如你对你博客的所有文章按照阅读量来排序），我觉得直接使用 MySQL 的 <code>ORDER BY</code> 关键字就可以了，没必要为了排行榜引入一个 Redis。</p> <p>另外，<strong>在没有分页并且数据量不大的情况下，直接在前端拿到所有需要用到的数据之后再进行排序也是可以的。</strong></p> <h2 id=""><a href="#" class="header-anchor">#</a></h2></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.3bc42cf8.js" defer></script><script src="/assets/js/3.0146fe10.js" defer></script><script src="/assets/js/1.760be874.js" defer></script><script src="/assets/js/11.d5259c34.js" defer></script>
  </body>
</html>
